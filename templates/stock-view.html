<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battery Stock View</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div class="header">
        <div class="menu-btn" id="menu-btn"><span></span><span></span><span></span></div>
        <div class="logo-container"><img src="/static/images/logo.jpg" alt="Company Logo" class="logo-img"></div>
    </div>
    <div id="side-nav" class="side-nav">
        <a href="javascript:void(0)" class="close-btn" id="close-btn">&times;</a>
        <a href="/home">Stock In</a>
        <a href="/stock-out">Stock Out (Warranty)</a>
        <a href="/stock-view">Detailed Report</a>
        <a href="/summary">Summary Report</a>
        {% if current_user.role == 'admin' %}
            <a href="/admin-users" class="admin-link">User Management</a>
        {% endif %}
        <a href="/logout" class="logout-link">Logout</a>
    </div>
    <div id="overlay"></div>
    <h1>Detailed Stock Report</h1>
    <h2 class="username-display">User: {{ current_user.username }} ({{ current_user.role }})</h2>

    <div class="tab-nav">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="loadStock('In Stock', this)">In Stock</button>
            <button class="tab-button" onclick="loadStock('Activated', this)">Activated</button>
        </div>
        <input type="date" id="date-filter" style="display: none;">
    </div>

    {% if current_user.role == 'admin' %}
    <div class="download-btn-container">
        <button id="download-btn" class="download-btn">Download Report (CSV)</button>
    </div>
    {% endif %}

    <input type="text" id="search-input" onkeyup="filterTable()" placeholder="Filter results by barcode, model, etc...">

    <div id="loading">Loading stock data...</div>

    <table id="stock-table" style="display:none;">
        <thead>
            <tr>
                <th>Barcode</th>
                <th>Model</th>
                <th>MFG Date</th>
                <th>Status</th>
                <th>Activation Date</th>
            </tr>
        </thead>
        <tbody id="stock-table-body">
            </tbody>
    </table>

    <script src="/static/nav.js"></script>
    
    <script>
        const tableBody = document.getElementById('stock-table-body');
        const table = document.getElementById('stock-table');
        const loadingText = document.getElementById('loading');
        const searchInput = document.getElementById('search-input');
        const dateFilter = document.getElementById('date-filter');
        const downloadBtn = document.getElementById('download-btn');
        
        // --- Store current report state ---
        let currentReportStatus = 'In Stock';
        let currentReportDate = '';

        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        dateFilter.value = today;

        // Add event listener to re-load data when date changes
        dateFilter.addEventListener('change', () => {
            loadStock('Activated', document.querySelector('.tab-button.active'));
        });

        // --- NEW: Download Button Click ---
        if (downloadBtn) {
            downloadBtn.addEventListener('click', () => {
                let url = `/api/admin/download-report?status=${currentReportStatus}`;
                if (currentReportStatus === 'Activated') {
                    url += `&date=${dateFilter.value}`;
                }
                // Open the download link in a new tab
                window.open(url, '_blank');
            });
        }

        function filterTable() {
            // (Unchanged)
            const filter = searchInput.value.toUpperCase();
            const rows = tableBody.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                let rowVisible = false;
                const cells = rows[i].getElementsByTagName('td');
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j] && cells[j].innerText.toUpperCase().indexOf(filter) > -1) {
                        rowVisible = true;
                        break;
                    }
                }
                rows[i].style.display = rowVisible ? "" : "none";
            }
        }

        function buildTable(data) {
            // (Unchanged)
            tableBody.innerHTML = '';
            if (data.length === 0) {
                loadingText.innerText = "No stock found for this query.";
                loadingText.style.display = 'block';
                table.style.display = 'none';
                return;
            }
            data.forEach(battery => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${battery.barcode}</td>
                    <td>${battery.model || 'N/A'}</td>
                    <td>${battery.mfg_date || 'N/A'}</td>
                    <td>${battery.status}</td>
                    <td>${battery.activation_date || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });
            table.style.display = 'table';
            loadingText.style.display = 'none';
            searchInput.value = '';
            filterTable();
        }

        function loadStock(status, clickedButton) {
            // (Unchanged logic from your last request)
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            clickedButton.classList.add('active');
            loadingText.style.display = 'block';
            table.style.display = 'none';

            let apiUrl;
            const activationHeader = document.querySelector('th:nth-child(5)');
            activationHeader.style.display = '';

            // --- Update current state for download ---
            currentReportStatus = status;

            if (status === 'In Stock') {
                apiUrl = '/api/get-stock';
                dateFilter.style.display = 'none';
            } else {
                const selectedDate = dateFilter.value;
                apiUrl = `/api/get-activated?date=${selectedDate}`;
                dateFilter.style.display = 'block';
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => buildTable(data))
                .catch(error => {
                    console.error('Error fetching stock:', error);
                    loadingText.innerText = 'Error loading stock data.';
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadStock('In Stock', document.querySelector('.tab-button.active'));
        });
    </script>
</body>
</html>